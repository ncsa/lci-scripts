# First: Replace XX with your cluster number (e.g., 01, 02, etc.)
# Using vim: vim commands, :%s/01/<clusternumber>/g, :wq
# Using nano: nano commands, Ctrl+\, Enter "01", Enter your cluster number, A, Ctrl+O, Enter, Ctrl+X

# Run as root
sudo -i
cd

# If you are reading this in a browser - Clone repository to your lci-head-XX-1
git clone https://github.com/ncsa/lci-scripts.git

# 1. Fix Hostname
correct_hostname=$(grep lci-head-[0-9][0-9]-1$ /etc/hosts | cut -f 2)
sudo hostnamectl set-hostname $correct_hostname

# 2. Install Ansible
dnf install -y ansible-core

# 3. Install Ansible on Compute Nodes and Run Playbook
cd ~
cp -a lci-scripts/introductory/2026/head_node/Head_node_playbook .
cd Head_node_playbook
# Edit hosts.ini: replace XX with cluster number in [head] and [all_nodes] sections
bash installansible.sh
ansible-playbook playbook.yml

# Verify services on head node
systemctl status mariadb
timedatectl status
showmount -e

# Test NFS
touch /head/NFS/testfile
ssh lci-compute-XX-1 ls /head/NFS
ssh lci-compute-XX-2 ls /head/NFS

# 4. Install ClusterShell
dnf install -y clustershell

# Edit /etc/clustershell/groups.d/local.cfg, remove existing uncommented content, add:
head: lci-head-XX-1
compute: lci-compute-XX-[1-2]
login: lci-head-XX-1
storage: lci-storage-XX-1

# Test ClusterShell
clush -g compute "uptime"

# Fix hostnames on compute nodes (remove .novalocal suffix)
# Get short hostname from /etc/hosts and set it properly
clush -g compute 'correct_hostname=$(grep $(hostname -s) /etc/hosts | grep lci-compute | head -1 | awk "{print \$2}"); sudo hostnamectl set-hostname $correct_hostname'

# Fix hostname on storage node
clush -g storage 'correct_hostname=$(grep $(hostname -s) /etc/hosts | grep lci-storage | head -1 | awk "{print \$2}"); sudo hostnamectl set-hostname $correct_hostname'

# Verify hostnames are fixed
clush -g compute,storage "hostname"

# 5. Create User Accounts
useradd -u 2002 justin
useradd -u 2003 katie

# 6. Configure Central Logging on Head Node
# Edit /etc/rsyslog.conf, uncomment:
module(load="imudp")
input(type="imudp" port="514")
module(load="imtcp")
input(type="imtcp" port="514")

# Add to end of '### Modules ###' section:
$template DynamicFile,"/var/log/%HOSTNAME%/forwarded-logs.log"
*.* -?DynamicFile

# Restart rsyslog on head node
systemctl restart rsyslog

# On compute and storage nodes, add to bottom of /etc/rsyslog.conf:
*.* @lci-head-XX-1

# Restart rsyslog on compute/storage nodes
systemctl restart rsyslog

# Verify on head node
ls /var/log/lci-compute-XX-*/
ls /var/log/lci-storage-XX-*/
