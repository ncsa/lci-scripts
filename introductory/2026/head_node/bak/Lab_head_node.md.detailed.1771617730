# Lab - Build a Cluster: Head Node

> **Quick Start:** For a condensed list of commands only, see [`todo.md`](todo.md) in this directory.

**Objective:** Setting up ssh host-based authentication and Ansible cluster management.
Enable Redhat powertools. Configure NFS server for user home directoris.

**Steps:**

- Fixing the host name on the head node.
- Setting ssh host-based authentication.
- Install Parallel Shell and configure for the cluster
- Configure central logging
- Install Ansible and configure Ansible environment for the cluster.
- Use Ansible playbooks to:
  - Install packages.
  - Restart MySQL (Mariadb) for SLURM accounting.
  - Check time synchronization and set time zone.
  - Configure NFS exports for user home directories.

---

## How to Update Files with Your Cluster Number

Replace `XX` with your cluster number (e.g., 02, 03, etc.) in all commands and configuration files.

Using vim:
```bash
vim todo.md
:%s/01/<clusternumber>/g
:wq
```

## Run the below commands as root

```bash
sudo -i
cd
```

## Pull the lci-scripts repository to get the playbook and other scripts:

```bash
git clone https://github.com/ncsa/lci-scripts.git
```

---

## 1. Fix Hostname

Current hostname:
```bash
hostname
```
- expected output on lci-head-01-1 (names will be different for your cluster):
```text
lci-head-01-1.novalocal
```

To change hostname, we need to find the correct one from the /etc/hosts file. The correct hostname should be lci-head, followed by two numbers, then -1.
```bash
correct_hostname=$(grep lci-head-[0-9][0-9]-1$ /etc/hosts | cut -f 2)
```

Now check that the hostname we have in the variable is correct:
```bash
echo $correct_hostname
```
```text
lci-head-01-1
```

Change the hostname:
```bash
hostnamectl set-hostname $correct_hostname
```

Verify the change:
```bash
hostname
```
```text
lci-head-01-1
```

---

## 2. Install Ansible

### On the head node:

```bash
dnf install -y ansible-core
```

---

## 3. Install Ansible on Compute Nodes and Run Ansible Playbook

The combined playbook configures both the head node and compute nodes.

```bash
cd ~
cp -a lci-scripts/introductory/2026/head_node/Head_node_playbook .
cd Head_node_playbook
# Edit hosts.ini and replace XX with your cluster number in both [head] and [all_nodes] sections
bash installansible.sh
ansible-playbook playbook.yml
```

### Verify services on head node:

```bash
systemctl status mariadb
timedatectl status
showmount -e
```

### Create file in /head/NFS on head node and verify it is visible on compute nodes:

```bash
touch /head/NFS/testfile
ssh lci-compute-XX-1 ls /head/NFS
ssh lci-compute-XX-2 ls /head/NFS
```

---

## 4. Install ClusterShell - to run commands on multiple nodes at once

```bash
dnf install -y clustershell
```

### Edit `/etc/clustershell/groups.d/local.cfg` remove everything uncommented and add:

```text
head: lci-head-XX-1
compute: lci-compute-XX-[1-2]
login: lci-head-XX-1
storage: lci-storage-XX-1
```

Test:
```bash
clush -g compute "uptime"
```

---

## 5. Create User Accounts

```bash
useradd -u 2002 justin
useradd -u 2003 katie
```

---

## 6. Configure Central Logging

### On head node (lci-head-XX-1):

Edit `/etc/rsyslog.conf`, uncomment:
```
module(load="imudp")
input(type="imudp" port="514")
module(load="imtcp")
input(type="imtcp" port="514")
```

Add to the end of '### Modules ###' section:
```
$template DynamicFile,"/var/log/%HOSTNAME%/forwarded-logs.log"
*.* -?DynamicFile
```

Restart:
```bash
systemctl restart rsyslog
```

### On compute and storage nodes:

Add to bottom of `/etc/rsyslog.conf`:
```
*.* @lci-head-XX-1
```

Restart:
```bash
systemctl restart rsyslog
```

### Verify on head node:

```bash
ls /var/log/lci-compute-XX-*/
ls /var/log/lci-storage-XX-*/
```

---

## Done!
